name: Deploy Render

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      RENDER_API_DEPLOY_HOOK_URL: ${{ secrets.RENDER_API_DEPLOY_HOOK_URL }}
      RENDER_WEB_DEPLOY_HOOK_URL: ${{ secrets.RENDER_WEB_DEPLOY_HOOK_URL }}
      DEPLOY_API_HEALTH_URL: ${{ secrets.DEPLOY_API_HEALTH_URL }}
      DEPLOY_WEB_HEALTH_URL: ${{ secrets.DEPLOY_WEB_HEALTH_URL }}
    steps:
      - name: Trigger API deploy
        run: |
          if [ -z "$RENDER_API_DEPLOY_HOOK_URL" ]; then
            echo "Skip API deploy hook (secret not set)"
            exit 0
          fi
          curl -fsS -X POST "$RENDER_API_DEPLOY_HOOK_URL"

      - name: Trigger Web deploy
        run: |
          if [ -z "$RENDER_WEB_DEPLOY_HOOK_URL" ]; then
            echo "Skip Web deploy hook (secret not set)"
            exit 0
          fi
          curl -fsS -X POST "$RENDER_WEB_DEPLOY_HOOK_URL"

      - name: Wait API health
        run: |
          if [ -z "$DEPLOY_API_HEALTH_URL" ]; then
            echo "Skip API health check (secret not set)"
            exit 0
          fi
          for i in $(seq 1 36); do
            code="$(curl -s -o /tmp/api-health.txt -w '%{http_code}' "$DEPLOY_API_HEALTH_URL" || true)"
            if [ "$code" = "200" ]; then
              echo "API healthy"
              cat /tmp/api-health.txt
              exit 0
            fi
            sleep 10
          done
          echo "API health check timeout"
          exit 1

      - name: Wait Web health
        run: |
          if [ -z "$DEPLOY_WEB_HEALTH_URL" ]; then
            echo "Skip Web health check (secret not set)"
            exit 0
          fi
          for i in $(seq 1 36); do
            code="$(curl -s -o /tmp/web-health.txt -w '%{http_code}' "$DEPLOY_WEB_HEALTH_URL" || true)"
            if [ "$code" = "200" ]; then
              echo "Web healthy"
              exit 0
            fi
            sleep 10
          done
          echo "Web health check timeout"
          exit 1
