# 設計方針 v4 - 見積原価管理システム

> 作成日: 2026-02-11
> 設計図v3を踏まえ、実装優先順位を再整理した方針書

---

## 基本方針

1. **Excelベースで継続**（Webアプリ化は将来の選択肢として保留）
2. **データ蓄積を最優先**（ダッシュボードはデータがあって初めて機能する）
3. **二重システムを解消**（旧シートを整理し、新システムに一本化）
4. **S表紙の動的切替を実現**（案件ごとに手動で数式を書き換えない）

---

## アーキテクチャ

```
┌─────────────────────────────────────────────────────┐
│                    制御層                             │
│  操作パネル → 案件作成ガイド / DB登録ガイド          │
└──────┬──────────────────────────────────────────────┘
       │
┌──────▼──────────────────────────────────────────────┐
│                    入力層                             │
│  案件テンプレート → 複製して P-XXX_案件名 を作成      │
│  ├─ A型: 原価逆算（客出し÷(1-利益率)）              │
│  ├─ B型: 定価固定（定価と原価を個別入力）            │
│  └─ C型: 単価固定（単価×数量）                       │
└──────┬──────────────────────────────────────────────┘
       │
┌──────▼──────────────────────────────────────────────┐
│                    処理層（マスタDB）                  │
│  ├─ 案件管理（30列・CRMパイプライン）                │
│  ├─ 工事項目DB（単価・利益率マスタ）                  │
│  ├─ 業者DB（協力会社60社以上）                       │
│  ├─ 顧客マスタ（管理会社・建設会社）                  │
│  ├─ マスター設定（経費率・消費税率）                  │
│  ├─ 請求管理【新規】                                │
│  └─ 支払管理【新規】                                │
└──────┬──────────────────────────────────────────────┘
       │
┌──────▼──────────────────────────────────────────────┐
│                    出力層                             │
│  ├─ Ｓ表紙（動的案件切替）                           │
│  ├─ 発注書兼請求書（業者DB・案件管理連携）           │
│  ├─ 請求書【改善】                                   │
│  ├─ 領収書【新規】                                   │
│  └─ 工程表（ガントチャート）                         │
└──────┬──────────────────────────────────────────────┘
       │
┌──────▼──────────────────────────────────────────────┐
│                    分析層                             │
│  ダッシュボード                                      │
│  ├─ 月別売上・受注推移                               │
│  ├─ 顧客ランキング（累計売上/件数）                   │
│  ├─ 業者別発注状況・遅延管理                          │
│  ├─ 粗利率分析（案件別/カテゴリ別）                   │
│  ├─ 請求・入金管理サマリー                            │
│  └─ ドリルダウン（ハイパーリンク → 各案件シート）     │
└─────────────────────────────────────────────────────┘
```

---

## 実装フェーズ

### Phase 0: 基盤整備（最優先）

**目的**: 二重システム解消 + S表紙の動的化

| タスク | 詳細 |
|--------|------|
| 旧シート非表示化 | 可視状態の旧7シート（解体/造作/建具/家具/電気設備'/タイル左官/仕上げ）を非表示に |
| S表紙の動的化 | J2セルのシート名を使い、INDIRECT関数でカテゴリ別集計を動的参照に変更 |
| 案件管理の列定義確定 | A-AD列の仕様をFIXし、今後の拡張ルールを決める |

**S表紙の動的化 数式案:**
```
現在: I36 = ='P-003_吉野様邸キッチン'!B105
変更: I36 = =INDIRECT("'"&J2&"'!B105")
```
→ J2にシート名を入力するだけで、どの案件の表紙にも切り替え可能。

---

### Phase 1: データ蓄積（ダッシュボードの前提条件）

**目的**: 分析に必要な最低限のデータを投入

| タスク | 対象データ |
|--------|-----------|
| 過去案件の入力 | 第3期の主要案件20〜30件を案件管理に登録 |
| 業者DB実データ | 主要協力会社（電気/大工/クリーニング/塗装等）を登録 |
| 顧客マスタ実データ | 矢島不動産管理、一建設、フィガロ、石澤クリーニング等 |
| 工事項目DB拡充 | 実際の見積で使う項目を追加 |

**優先度**:
- 顧客マスタ → ダッシュボードの「顧客ランキング」に直結
- 過去案件 → 月別推移・粗利分析に必要
- 業者DB → 発注管理・支払管理に必要

---

### Phase 2: 金流管理シート

**目的**: 請求→入金→支払の流れを管理

#### 請求管理シート（新規作成）

| 列 | 項目 |
|----|------|
| A | 請求ID |
| B | 案件ID（案件管理へのリンク） |
| C | 顧客名（自動参照） |
| D | 請求金額 |
| E | 請求日 |
| F | 支払期限 |
| G | 入金日 |
| H | 入金額 |
| I | 差額 |
| J | ステータス（未請求/請求済/入金済/遅延） |

#### 支払管理シート（新規作成）

| 列 | 項目 |
|----|------|
| A | 支払ID |
| B | 案件ID |
| C | 業者ID（業者DBへのリンク） |
| D | 業者名（自動参照） |
| E | 発注金額 |
| F | 発注日 |
| G | 支払期限 |
| H | 支払日 |
| I | 支払額 |
| J | ステータス（未発注/発注済/支払済/遅延） |

---

### Phase 3: ダッシュボード再構築

**目的**: ユーザーが求める分析機能の実装

#### セクション構成

| セクション | 内容 | 主要関数 |
|-----------|------|---------|
| KPIサマリー | 月間売上/件数/粗利率/滞留件数 | SUMIFS, COUNTIFS |
| 月別推移 | 売上・受注の月別推移 | SUMIFS+月別集計 |
| 顧客ランキング | 累計売上TOP10/件数TOP10 | LARGE+INDEX+MATCH |
| 業者分析 | 発注額/遅延率/支払状況 | 支払管理シート参照 |
| 請求入金 | 未回収額/回収率/滞留リスト | 請求管理シート参照 |
| 粗利分析 | 案件別/カテゴリ別粗利率 | 案件管理H列集計 |

#### ドリルダウン実装方法
- 顧客名セルにHYPERLINK関数でシート内リンクを設定
- クリックで該当顧客の案件一覧にジャンプ
- `=HYPERLINK("#案件管理!A1","詳細→")` 形式

---

### Phase 4: ドキュメント出力の改善

| タスク | 詳細 |
|--------|------|
| 請求書テンプレート | 発注書兼請求書を分離し、専用テンプレート化 |
| 領収書 | 新規作成（請求管理と連携） |
| 印刷レイアウト | A4縦/横の印刷範囲を全帳票で設定 |

---

### Phase 5: 操作マニュアル

| タスク | 詳細 |
|--------|------|
| 日常操作ガイド | 案件登録→見積作成→請求→入金確認のフロー |
| 初期設定ガイド | マスター設定/業者DB/顧客マスタの登録方法 |
| トラブルシューティング | よくあるエラーと対処法 |

---

## 将来の展望

### Excelの限界が見えるタイミング
- 案件数が100件を超え、VLOOKUP/INDEXが遅くなる
- 複数人で同時編集したい
- スマホ/タブレットから現場で入力したい

### Webアプリ化の方向性
- 現在のExcelのデータ構造（案件管理30列、DB構造）がそのままDBスキーマになる
- Next.js + Supabase or 管理会社ポータル（別途設計書あり）との統合
- Excelからのデータ移行パスを事前設計しておく

---

## 案件管理 列定義（30列・確定版）

| 列 | 項目 | 型 | 説明 |
|----|------|----|------|
| A | 案件ID | TEXT | P-001形式 |
| B | 案件名 | TEXT | |
| C | 顧客ID | TEXT | C-001形式 → 顧客マスタ参照 |
| D | 顧客名 | TEXT/VLOOKUP | |
| E | 担当者 | TEXT | |
| F | 見積金額 | NUMBER | 案件シート!K50参照 |
| G | 実行予算 | NUMBER | 案件シート!G50参照 |
| H | 粗利率 | CALC | =(F-G)/F |
| I | ステータス | TEXT | ①〜⑦の7段階 |
| J | 見積日 | DATE | |
| K | 受注日 | DATE | |
| L | 着工日 | DATE | |
| M | 完工日 | DATE | |
| N | 見積提出日 | DATE | |
| O | 失注理由 | TEXT | |
| P | 次回アクション | TEXT | |
| Q | メモ | TEXT | |
| R | 更新日 | DATE | |
| S | 施工場所 | TEXT | |
| T | 工事種別 | TEXT | |
| U | 完工予定日 | DATE | |
| V | 工期余日 | CALC | =U-TODAY() |
| W | 工期アラート | CALC | 🔴超過/🟡注意/🟢順調 |
| X | 請求書ステータス | TEXT | |
| Y | 請求日 | DATE | |
| Z | 請求金額 | NUMBER | |
| AA | 入金ステータス | TEXT | |
| AB | 入金日 | DATE | |
| AC | 入金額 | NUMBER | |
| AD | 受注区分 | CALC | 🟢受注/🔴失注/⚪商談中 |
