# 機能仕様凍結

作成日: 2026-02-17  
対象リポジトリ: `link-estimate-system`  
基準コミット: `b437828a1311c16bc7b915bbef02beb000cd5eff`

## 1. 目的

本書は、Excel/VBA実装をアプリへ移行するための機能契約を凍結する。  
ここで定義する「入力」「処理」「出力」を、MVP実装の唯一の正として扱う。

## 2. 凍結スコープ

- `excel/見積原価管理システム.xlsm`（45シート）
- `vba/Module_NewProject.bas`
- `scripts/validate_workbook.py` の検証観点

## 3. 機能契約（凍結）

## F-01 新規案件作成

対象マクロ: `新規案件作成`

### 入力契約

- `操作パネル!B7` 顧客ID（必須）
- `操作パネル!D7` 顧客名（参照値）
- `操作パネル!B9` 担当者（未入力時は `吉野博`）
- `操作パネル!D9` 目標粗利率（数値でない場合は `0.25`）
- InputBox #1: 物件名（必須）
- InputBox #2: 施工住所（任意）
- Confirm: 最終確認（Yesで続行、Noで中断）

### 処理契約

1. `案件管理!A` から最大 `P-xxx` を走査して次番号を採番  
2. `案件テンプレート` をコピーして新規シートを作成  
3. シート名は `P-xxx_物件名` をベースに禁則文字除去  
4. 重複時は `_2`, `_3` を付与して31文字以内に調整  
5. 新シートへ以下を書込
   - `B3`: 案件ID
   - `B4`: 物件名
   - `B5`: 顧客名
   - `B7`: 目標粗利率
6. `案件管理` の次行へ追加
   - A: 案件ID
   - B: 顧客ID
   - C: 顧客名
   - D: 物件名
   - I: `①リード`
   - M: 担当者
   - S: 作成日（Date）
   - AE: 施工住所
   - AF: 物件名
7. `案件管理` の計算列設定
   - F: `='<新規シート>'!K50`
   - G: `='<新規シート>'!G50`
   - H: `=IF(AND(Fn<>"",Gn<>""),(Fn-Gn)/Fn,"")`
   - AD: 受注区分判定
8. `Ｓ表紙!J2` にシート名、`Ｓ表紙!J3` に案件IDを設定
9. 新規シートへ遷移し `B15` を選択

### エラー/中断契約

- B7空: 警告表示して中断
- 物件名空: 中断
- Confirm=No: 中断
- 例外時: 警告表示、`ScreenUpdating` を復元

## F-02 S表紙PDF出力

対象マクロ: `S表紙PDF出力`

### 入力契約

- `Ｓ表紙!J2` 案件シート名（必須）

### 出力契約

- 保存先: Desktop
- ファイル名: `見積書_<案件名>_yyyymmdd.pdf`
- 出力範囲: `Ｓ表紙!$A$1:$I$61`

### 例外契約

- J2空: 警告して終了
- Confirm=No: 終了

## F-03 領収書PDF出力

対象マクロ: `領収書PDF出力`

### 入力契約

- `領収書!J2` 請求ID（必須）

### 出力契約

- 保存先: Desktop
- ファイル名: `領収書_<請求ID>_yyyymmdd.pdf`
- 出力範囲: `領収書!$A$1:$H$26`

### 例外契約

- J2空: 警告して `J2` を選択し終了

## F-04 発注書PDF出力

対象マクロ: `発注書PDF出力`

### 入力契約

- `発注書兼請求書!B1` 帳票種別（空時は `発注書`）
- `発注書兼請求書!D1` 案件ID
- `発注書兼請求書!G1` 業者ID

### 出力契約

- 保存先: Desktop
- ファイル名: `<帳票種別>_<案件ID>_<業者ID>_yyyymmdd.pdf`
- 出力範囲: `発注書兼請求書!$A$1:$I$47`

## F-05 操作パネルボタン配置

対象マクロ: `操作パネルボタン配置`

### 生成契約

- 対象シート: `操作パネル`
- 配置ボタン（既存同名は再作成）
  - `btn新規案件作成` -> `新規案件作成`
  - `btnS表紙PDF出力` -> `S表紙PDF出力`
  - `btn領収書PDF出力` -> `領収書PDF出力`

## 4. 計算契約（凍結）

## C-01 案件管理

基準行: 5行目（以降同一パターン）

- H: `=IF(AND(Fn<>"",Gn<>""),(Fn-Gn)/Fn,"")`
- K: `=IF(Jn<>"",TODAY()-Jn,"")`
- L: `=IF(AND(Kn<>"",Kn>30,NOT(OR(In="⑤受注",In="⑦完工",In="⑥失注"))),"⚠滞留","")`
- V: `=IF(AND(Un<>"",OR(In="⑤受注",In="③見積作成中",In="④見積提出済")),Un-TODAY(),"")`
- W: `=IF(Vn="","",IF(Vn<0,"⚠工期超過",IF(Vn<=7,"⚠残り"&Vn&"日","")))`
- X: `=IF(In="","",IF(COUNTIFS(請求管理!B:B,An)>0,"✅発行済","❌未発行"))`
- AA: `=IF(In="","",IF(COUNTIFS(請求管理!B:B,An)=0,"",IF(SUMIFS(請求管理!J:J,請求管理!B:B,An)<=0,"✅入金済","❌未入金")))`
- AD: `=IF(OR(In="⑤受注",In="⑦完工"),"🟢受注",IF(In="⑥失注","🔴失注",IF(In="","","🟡商談中")))`

## C-02 S表紙

- I36:I55: 案件シートのカテゴリ別金額（B105:B124）
- I56: `=SUM(I36:I54)*マスター設定!K20`
- I57: `=SUM(I36:I54)*マスター設定!K21`
- I58: `=マスター設定!K23*マスター設定!K22`
- I59: `=SUM(I36:I58)*マスター設定!K24`

## C-03 請求管理

基準行: 5行目

- A: `=IF(Bn="","","INV-"&TEXT(ROW()-4,"000"))`
- J: `=IF(Bn="","",IF(Gn="","",Gn-IF(In="",0,In)))`
- K: `=IF(Bn="","",IF(Gn="","",IF(Jn<=0,"✅入金済",IF(In<>"","⚠一部入金",IF(Fn<>"","❌未入金","")))))`

## C-04 支払管理

基準行: 5行目

- A: `=IF(Bn="","","PAY-"&TEXT(ROW()-4,"000"))`
- D: `=IF(Cn="","",IFERROR(VLOOKUP(Cn,業者DB!A:B,2,FALSE),""))`
- J: `=IF(Bn="","",IF(Gn="","",Gn-IF(In="",0,In)))`
- K: `=IF(Bn="","",IF(Gn="","",IF(Jn<=0,"✅支払済",IF(In<>"","⚠一部支払",IF(Fn<>"","❌未支払","")))))`

## 5. 入力制約（Data Validation）

- `操作パネル!B7`: `顧客マスタ!$A$5:$A$104`（リスト）
- `案件管理!I5:I96`: `①リード,②商談中,③見積作成中,④見積提出済,⑤受注,⑥失注,⑦完工`
- `案件管理!X5:X96`: `✅発行済,❌未発行`
- `案件管理!AA5:AA96`: `✅入金済,❌未入金`
- `案件管理!E5:E96`: 工事種別リスト

## 6. 非機能契約（MVP向け）

- IDは既存体系を維持
  - 案件ID: `P-\d{3}`
  - 顧客ID: `C-\d{3}`
  - 請求ID: `INV-\d{3}`
  - 支払ID: `PAY-\d{3}`
- ファイル名禁則文字は `_` に置換
- 出力PDFは日付サフィックス `yyyymmdd` を必須

## 7. 既知差分（移行前に要調整）

- `Ｓ表紙!I36:I55` は現ブック上で一部ハードコード参照が残るケースがある。  
  アプリ側では「`J2` の案件選択で動的に切替」が正仕様。
- Excel UI依存（InputBox/MsgBox/ボタン割当）が運用不安定要因。  
  アプリではすべてフォーム/通知コンポーネントへ置換する。

