# APP化詳細設計 (2026-02-17)

## 1. 判断

- **Excel必須ではない**。
- 既存GitHub資産（Excel構造 + VBA仕様 + 検証スクリプト）を使って、同等業務をWebアプリ化できる。
- 推奨は **段階移行**（Excelを止めずにアプリを並行構築）。

## 2. 現行資産の再利用マップ

### 2.1 業務ロジック（VBA -> アプリ）

対象: `/Users/yoshinohiroshi/Library/Mobile Documents/iCloud~md~obsidian/Documents/情報オブシディアン/100_Cursor/link-estimate-system/vba/Module_NewProject.bas`

- `新規案件作成`
  - 案件ID採番: `P-001` 形式、既存最大 + 1
  - 入力契約: 顧客ID（操作パネルB7）、担当者（B9）、目標粗利率（D9）
  - 案件管理への書込列: A, B, C, D, I, M, S, AE, AF
- `S表紙PDF出力`
  - 出力名: `見積書_<案件名>_yyyymmdd.pdf`
- `領収書PDF出力`
  - 出力名: `領収書_<請求ID>_yyyymmdd.pdf`
- `発注書PDF出力`
  - 出力名: `<帳票種別>_<案件ID>_<業者ID>_yyyymmdd.pdf`
- 共通関数
  - ファイル名/シート名サニタイズ
  - シート存在チェック

### 2.2 データ構造（シート -> DB）

対象: `/Users/yoshinohiroshi/Library/Mobile Documents/iCloud~md~obsidian/Documents/情報オブシディアン/100_Cursor/link-estimate-system/excel/見積原価管理システム.xlsx`

主要ソース:

- `案件管理`（基幹）
  - 案件ID、顧客ID、案件名、見積金額、実行予算、粗利率、ステータス、担当者、請求/入金、施工住所
- `顧客マスタ`
  - 顧客ID、会社名、担当者、住所、連絡先、ステータス
- `業者DB`
  - 業者ID、業者名、得意工事、支払条件
- `工事項目DB`
  - 工事項目、標準単価、利益率
- `請求管理`
  - 請求ID、案件ID、請求額、入金額、残額
- `支払管理`
  - 支払ID、案件ID、業者ID、発注額、支払額、残額

## 3. 推奨アーキテクチャ（Excel親和性を維持）

- Frontend: Next.js + TypeScript
- Grid UI: AG Grid または Handsontable（Excel操作感を優先）
- Backend: FastAPI（Python）
- DB: PostgreSQL
- PDF: HTMLテンプレート + Playwright/PDF生成
- 認証: Google/Microsoft SSO + ロール管理（管理者/営業/経理）

理由:

- Excel感の強い入力体験を再現しやすい
- Pythonで既存検証ロジックを再利用しやすい
- PDF出力仕様の差分検証を自動化しやすい

## 4. 段階移行計画（実行順）

## Phase 0: 仕様凍結（1週間）

- 入力契約・出力契約・計算契約を固定
- ゴールデンデータ（10案件）を確定
- Excel結果を正解データとして保存

成果物:

- `docs/機能仕様凍結.md`
- `docs/データ辞書.md`
- `docs/PDF仕様.md`

## Phase 1: MVP（2〜3週間）

対象機能（Excel代替の最短）:

1. 新規案件作成
2. S表紙PDF出力
3. 領収書PDF出力

並行運用:

- 同案件をExcelとアプリで処理
- 数値・PDFの差分比較を実施

## Phase 2: 拡張（2週間）

- 発注書PDF
- 請求管理/支払管理画面
- 顧客・業者マスタメンテ
- CSV/Excel入出力

## Phase 3: 切替判断（1週間）

判定条件:

- 新規案件作成成功率 100%
- PDF主要項目一致率 100%（レイアウトは目視承認）
- 操作時間がExcel比で悪化しない

## 5. 技術リスクと対策

- 数式差異（丸め/税）
  - Excel結果を正とする差分テストをCI化
- PDFレイアウト差異
  - 項目比較 + 目視承認フロー
- 現場受容性
  - 先に操作パネル相当画面のプロトタイプを実運用テスト

## 6. いまのフリーズ問題の位置づけ

- 問題の本質は業務ロジックではなく、**Excel UI自動操作の不安定性**。
- アプリ化すると以下が解消される:
  - マクロ有効化依存
  - VBE手作業
  - モーダルダイアログによる自動化停止

## 7. 直近の実行提案

1. Phase 0（仕様凍結）を先に完了
2. MVPの画面/APIを先に確定
3. 実装は新規ディレクトリ（例: `app/`）で開始
4. Excel運用は切替完了まで継続

