# LinK Estimate OS 戦略プラン

> 作成: 2026-02-20 / 責任者: Claude（吉野さん承認待ち）
> 3チーム並列調査の結果を統合

---

## 現状の事実（数字ベース）

### コードベース
| 項目 | 数値 |
|------|------|
| ページ数 | 12 |
| UIコンポーネント | 9 |
| DBテーブル | 10（RLS 12ポリシー完備） |
| コード総行数 | ~8,000-10,000 |
| CRUD関数 | 22（supabase-ops.ts: 1,750行） |
| 型定義 | 25+（any型: 0、console.log: 0） |
| コード完成度 | **95%** |

### デプロイ状況（危険）
| 項目 | 状態 |
|------|------|
| Vercel本番 | `5392e6f`（2/18デプロイ） — **古い** |
| 未反映コード | Phase 1-3 + 管理者機能 + セキュリティ修正17件 |
| main未push | **7コミット** — GitHubにない |
| phase1未push | **5コミット** — GitHubにない |
| 未コミット変更 | 27行（Dev Bypass追加） |
| Node.js | Vercel: 24.x / ローカル: 20 — **乖離あり** |

### 根本的な設計問題（リビルドが必要な理由）
| 問題 | 影響 |
|------|------|
| projectsテーブルに集計カラムなし | 毎回全テーブル読んでメモリ内集計 → データ増加で遅延 |
| vendorsに掛け率が1値しかない | 工事項目ごとの掛け率管理不可 |
| paymentsにcost_priceなし | 原価率計算不可 |
| /financeページ未実装 | 会計センターがない（リダイレクトのみ） |
| 請求書PDFなし | 見積書PDFのみ。請求・領収は別システム？ |
| ダッシュボードにDSO等なし | 銀行融資判断に不足 |

---

## 判断: フルリビルドではなく「段階的強化」

### 理由
1. **コード品質が高い**（完成度95%、型安全、RLS完備）→ 捨てるのはもったいない
2. **データモデルの核は正しい**（project_itemsにcost_price/selling_priceある）
3. **足りないのは集計層と会計フロー** → テーブル追加+API強化で対応可能
4. **フルリビルドは3-4週間** vs **段階的強化は10日** → 10日で同等以上の成果

### 「全面作り直し」の再解釈
吉野さんの2/18指示「旧UIは全部捨てていい」は、**見た目の刷新**を許可する発言であり、**動いているCRUD・RLS・認証基盤を捨てろ**ではないと判断。基盤は残して、足りない部分を積み上げる方が速い。

---

## 実行計画（全5フェーズ・10日）

### Phase 0: 安全確保（即座・30分）
**目的**: コード消失リスクの排除

| タスク | 内容 |
|--------|------|
| 未コミット変更をコミット | providers.tsx, auth-context.tsx, middleware.ts, finance/ |
| mainブランチをpush | 7コミットをGitHubに反映 |
| phase1ブランチをpush | 5コミットをGitHubに反映 |
| Node.jsバージョン確認 | Vercel設定を20に変更（24.xから） |

### Phase 1: デプロイ+動作確認（1日）
**目的**: 最新コードを本番に反映し、現状を目で見る

| タスク | 内容 |
|--------|------|
| phase1 → mainマージ | 全Phase 1-3のコードをmainに統合 |
| Vercelデプロイ | `npx vercel deploy --prod --yes` |
| テストアカウントで全画面確認 | test@link8reform.com / TestPass123! |
| スクリーンショット取得 | 全12ページのビフォー記録 |
| バグリスト作成 | 動作確認で見つけた問題を記録 |

**成果物**: 動く本番URL + 全画面スクリーンショット + バグリスト

### Phase 2: スキーマ拡張+銀行ダッシュボード（3日）
**目的**: 銀行融資判断に使えるダッシュボードにする

| タスク | 内容 |
|--------|------|
| projectsに集計カラム追加 | total_cost, total_selling, margin, margin_rate |
| monthly_kpiテーブル新設 | 月次の売上・原価・粗利をキャッシュ |
| project_summary自動更新トリガー | 明細変更時に自動再計算 |
| ダッシュボード高速化 | メモリ集計 → DB集計に切り替え |
| 銀行指標追加 | 月次粗利率トレンド、DSO、キャッシュポジション推移 |
| house-os移植: エラーハンドリング | error-handler.ts パターンを導入 |

**成果物**: 銀行に見せられるダッシュボード

### Phase 3: 一気通貫フロー（3日）
**目的**: 見積→請求→入金→支払が1システムで完結

| タスク | 内容 |
|--------|------|
| /finance 会計センター実装 | 未入金一覧、期限超過アラート、消込UI |
| 請求書PDF生成 | 見積書PDFの基盤を流用 |
| 入金消込機能 | 請求額と入金額の照合、一部入金対応 |
| 支払追跡強化 | paymentsにcost_price追加、発注→支払の追跡 |
| house-os移植: メール送信 | Resendパターンで見積送付・請求リマインダー |
| house-os移植: APIミドルウェア | withCompanyAccess()パターンを全APIに適用 |

**成果物**: 案件作成→見積→請求→入金が1画面で完結するフロー

### Phase 4: 実データ投入+仕上げ（3日）
**目的**: ダミーデータを実データに置換、本番運用開始

| タスク | 内容 |
|--------|------|
| 仕入先60社をDBに投入 | Obsidian `36_Business/finance/仕入先/` + 吉野さん提供データ |
| 顧客マスター投入 | 矢島不動産、一建設、フィガロ等の実データ |
| 掛け率マトリクス実装 | 仕入先×工事項目の掛け率テーブル |
| キツタカ単価データ投入 | Obsidianの実データをそのまま |
| シードデータ差し替え | ダミー → 実データ |
| house-os移植: CI/CD | GitHub Actions（Lint→TypeCheck→Build） |
| 本番運用テスト | 吉野さんに実際に操作してもらう |

**成果物**: 実データ入り本番システム + 操作マニュアル

---

## house-osから移植する機能（優先順位順）

| 順位 | 機能 | Phase | 移植元ファイル |
|------|------|-------|---------------|
| 1 | エラーハンドリング | 2 | error-handler.ts (331行) |
| 2 | Resendメール送信 | 3 | resend.ts + send-email routes |
| 3 | APIミドルウェア | 3 | api-middleware.ts (366行) |
| 4 | CI/CDパイプライン | 4 | .github/workflows/ci.yml |
| 5 | 自動採番 | 4 | auto-number.ts |
| 6 | Git flow | 4 | CLAUDE.md設定 |

Slack Bot、ゲーミフィケーション等は**今は不要**。銀行ダッシュボード+一気通貫フローが最優先。

---

## リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| Node.jsバージョン乖離 | ビルド失敗 | Phase 0でVercelを20に統一 |
| Supabaseスキーマ変更 | 既存データ破壊 | ALTER TABLE + デフォルト値で安全に拡張 |
| 未pushコミット消失 | コード全滅 | Phase 0で即push |
| Vercelデプロイ上限 | 1日100回 | ローカルビルド確認→1日2-3回に制限 |
| 認証テストのレート制限 | 開発ブロック | Dev Bypass活用、認証テストは最後 |

---

## 数字で見る効果

| 指標 | 現状 | Phase 4完了後 |
|------|------|--------------|
| ダッシュボード読み込み | ~3秒（全テーブル集計） | ~0.5秒（DB集計キャッシュ） |
| 銀行融資指標 | 8個 | 14個（+DSO, キャッシュ推移, 月次粗利等） |
| 帳票種類 | 1種（見積書） | 3種（+請求書, 領収書） |
| 一気通貫フロー | 見積のみ | 見積→請求→入金→支払 |
| 仕入先データ | 5社（ダミー） | 60社+（実データ） |
| APIエラーハンドリング | 個別try-catch | 統一エラーハンドラー |
| CI/CD | なし | Lint→TypeCheck→Build自動チェック |

---

## 工数見積

| Phase | 日数 | 主要タスク |
|-------|------|-----------|
| Phase 0 | 0.5日 | git push + Node.js統一 |
| Phase 1 | 1日 | デプロイ + 全画面確認 |
| Phase 2 | 3日 | スキーマ拡張 + 銀行ダッシュボード |
| Phase 3 | 3日 | 会計センター + 請求書PDF + 消込 |
| Phase 4 | 3日 | 実データ投入 + CI/CD + 運用テスト |
| **合計** | **10日** | |

---

## 判断いただきたいこと

1. **この方向性（段階的強化 vs フルリビルド）でいいか**
2. **Phase優先順位の変更はあるか**（例：Phase 4の実データを先にしたい等）
3. **仕入先データ**: キツタカ以外の単価データはどこから取るか（Obsidian? 手入力?）
4. **Go/No-Go**: このプランで進めていいか
